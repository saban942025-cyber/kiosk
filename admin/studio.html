<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Studio Master </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #E3000F; }
        
        /* Media Cards */
        .media-card { cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative; overflow: hidden; }
        .media-card:hover { transform: scale(1.05); z-index: 10; border-color: #3b82f6; }
        .media-card.selected { border-color: #E3000F; box-shadow: 0 0 15px rgba(227, 0, 15, 0.3); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="flex">

    <div class="w-72 bg-gray-900 border-l border-gray-800 flex flex-col z-20 shadow-xl">
        <div class="p-5 border-b border-gray-800 bg-gray-900">
            <h1 class="text-3xl font-black text-[#E3000F] tracking-tighter italic">SIKA STUDIO</h1>
            <p class="text-xs text-gray-500 mt-1"> 拽 </p>
        </div>
        <div class="p-3 bg-gray-900 sticky top-0">
            <button onclick="clearForm()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                <i data-lucide="plus-circle" size="18"></i> 爪专 砖
            </button>
        </div>
        <div id="inventoryList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>

    <div class="flex-1 p-6 overflow-y-auto bg-[#0f172a]">
        <div class="max-w-7xl mx-auto flex gap-8">
            
            <div class="w-2/3 space-y-6">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                    
                    <div class="flex gap-3 mb-5">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="absolute right-3 top-3 text-gray-500" size="20"></i>
                            <input id="searchQuery" class="input-dark font-bold text-lg pr-10" placeholder="拽 砖 爪专 转专  (砖: Sika TopSeal 107)">
                        </div>
                        <button onclick="runAllSearches()" class="bg-[#E3000F] hover:bg-red-600 text-white px-6 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                            <i data-lucide="sparkles"></i> 驻砖 
                        </button>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-[10px] text-gray-400 font-bold uppercase mb-2 flex justify-between">
                            <span>转转 (Google)</span>
                            <span class="text-gray-600 text-[9px]">抓 专</span>
                        </h3>
                        <div id="imageGrid" class="grid grid-cols-5 gap-3 h-24 content-start">
                            <div class="col-span-5 text-center text-gray-600 text-sm py-8 border border-dashed border-gray-700 rounded-lg">转 驻砖...</div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-[10px] text-gray-400 font-bold uppercase mb-2"> (YouTube)</h3>
                        <div id="videoGrid" class="grid grid-cols-4 gap-3 h-24 content-start">
                            <div class="col-span-4 text-center text-gray-600 text-sm py-8 border border-dashed border-gray-700 rounded-lg">转 驻砖...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-md">
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">砖 爪专</label>
                            <input id="pName" class="input-dark font-bold text-lg border-l-4 border-l-blue-500" placeholder="砖 ">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">转</label>
                                <input id="pBrand" class="input-dark" placeholder="Sika / Brand">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">拽专</label>
                                <select id="pCat" class="input-dark">
                                    <option value="sealing"> (Sealing)</option>
                                    <option value="glues">拽 (Glues)</option>
                                    <option value="flooring">专爪祝 (Flooring)</option>
                                    <option value="concrete"> (Concrete)</option>
                                    <option value="paint">爪注 (Paint)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">转专 砖拽</label>
                            <textarea id="pDesc" class="input-dark h-24 text-sm leading-relaxed" placeholder="转专 砖专 转 爪专..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input id="pImg" class="input-dark text-[10px] text-gray-500" readonly placeholder="Image URL">
                            <input id="pVideo" class="input-dark text-[10px] text-gray-500" readonly placeholder="Video URL">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800 relative shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-bold text-gray-300 flex items-center gap-2">
                            <i data-lucide="ruler" class="text-blue-500"></i> 驻专 
                        </label>
                        <button onclick="fillTechData()" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 text-xs px-3 py-1.5 rounded-full flex items-center gap-1 transition border border-blue-500/30">
                            <i data-lucide="sparkles" size="12"></i>   (AI)
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-5">
                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-[11px] text-gray-500 font-medium">住 / 爪专</span>
                                <button onclick="smartSearch('coverage')" class="text-gray-600 hover:text-white transition bg-gray-800 p-1 rounded hover:bg-blue-600" title="驻砖 转 爪专 ">
                                    <i data-lucide="search" size="10"></i>
                                </button>
                            </div>
                            <input id="tCov" class="input-dark text-sm border-gray-800 focus:border-blue-500" placeholder="1.5 拽'' ''专">
                        </div>

                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-[11px] text-gray-500 font-medium"> 砖</span>
                                <button onclick="smartSearch('drying')" class="text-gray-600 hover:text-white transition bg-gray-800 p-1 rounded hover:bg-blue-600" title="驻砖 转 砖 ">
                                    <i data-lucide="search" size="10"></i>
                                </button>
                            </div>
                            <input id="tDry" class="input-dark text-sm border-gray-800 focus:border-blue-500" placeholder="24 砖注转">
                        </div>

                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5">
                                <span class="text-[11px] text-gray-500 font-medium">注 砖</span>
                                <button onclick="smartSearch('thickness')" class="text-gray-600 hover:text-white transition bg-gray-800 p-1 rounded hover:bg-blue-600" title="驻砖 转 注 ">
                                    <i data-lucide="search" size="10"></i>
                                </button>
                            </div>
                            <input id="tThick" class="input-dark text-sm border-gray-800 focus:border-blue-500" placeholder="2-5 ''">
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-800 text-center">
                        <button onclick="smartSearch('pdf')" class="text-xs text-gray-500 hover:text-white flex items-center justify-center gap-1 w-full transition">
                            <i data-lucide="file-text" size="12"></i> 驻砖 祝 爪专 拽专 (PDF Technical Data Sheet)
                        </button>
                    </div>
                </div>

                <button onclick="saveProduct()" class="w-full bg-gradient-to-r from-[#E3000F] to-red-700 hover:from-red-600 hover:to-red-800 text-white py-4 rounded-xl font-bold text-xl shadow-lg transform transition hover:scale-[1.01] flex justify-center gap-2 items-center">
                    <i data-lucide="save"></i> 砖专 爪专
                </button>
            </div>

            <div class="w-1/3 min-w-[320px]">
                <div class="sticky top-6 bg-white text-black rounded-[2.5rem] overflow-hidden shadow-2xl border-8 border-gray-900 flex flex-col h-[750px]">
                    <div class="h-[40%] bg-gray-100 flex items-center justify-center relative p-6 border-b border-gray-100">
                        <img id="previewImg" src="https://placehold.co/400?text=Sika" class="max-h-full max-w-full object-contain mix-blend-multiply transition-all duration-500">
                        <div id="videoBadge" class="absolute bottom-4 right-4 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-md hidden flex items-center gap-1">
                            <i data-lucide="youtube" size="12"></i> VIDEO
                        </div>
                    </div>
                    
                    <div class="p-6 flex-1 flex flex-col overflow-y-auto">
                        <div id="prevBrand" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">BRAND</div>
                        <h2 id="prevName" class="text-3xl font-black leading-none mb-3 text-gray-900">砖 爪专</h2>
                        
                        <div class="flex gap-1 mb-4">
                            <div class="h-1 w-8 bg-[#E3000F] rounded-full"></div>
                            <div class="h-1 w-2 bg-gray-300 rounded-full"></div>
                        </div>

                        <p id="prevDesc" class="text-sm text-gray-600 leading-relaxed mb-6">转专 爪专 驻注   转...</p>
                        
                        <div class="bg-gray-50 rounded-xl p-4 grid grid-cols-3 gap-2 mb-4">
                            <div class="text-center">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">住</div>
                                <div id="prevCov" class="font-bold text-xs text-gray-800 mt-1">-</div>
                            </div>
                            <div class="text-center border-r border-gray-200 border-l">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">砖</div>
                                <div id="prevDry" class="font-bold text-xs text-gray-800 mt-1">-</div>
                            </div>
                            <div class="text-center">
                                <div class="text-[9px] text-gray-400 uppercase font-bold">注</div>
                                <div id="prevThick" class="font-bold text-xs text-gray-800 mt-1">-</div>
                            </div>
                        </div>

                        <div id="previewVideoContainer" class="hidden mt-auto">
                            <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">专 </p>
                            <iframe id="previewIframe" class="w-full aspect-video rounded-xl bg-black shadow-lg" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { searchProductImages, searchYouTubeVideos, askGeminiAdmin, extractTechnicalSpecs } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        // --- 1. Master Search (Text, Image, Video) ---
        window.runAllSearches = async () => {
            const query = document.getElementById('searchQuery').value;
            if(!query) return alert("  砖 爪专");

            // AI Text Fill (if empty)
            if(!document.getElementById('pName').value) {
                document.getElementById('pName').value = query;
                askGeminiAdmin(query).then(data => {
                    if(data) {
                        document.getElementById('pDesc').value = data.marketingDesc;
                        document.getElementById('pBrand').value = data.brand;
                        updatePreview();
                    }
                });
            }

            // Media Search
            const imgGrid = document.getElementById('imageGrid');
            const vidGrid = document.getElementById('videoGrid');
            
            imgGrid.innerHTML = '<div class="col-span-5 text-center py-4"><i data-lucide="loader-2" class="animate-spin inline text-blue-500"></i> 驻砖 转转...</div>';
            vidGrid.innerHTML = '<div class="col-span-4 text-center py-4"><i data-lucide="loader-2" class="animate-spin inline text-red-500"></i> 驻砖 ...</div>';
            lucide.createIcons();

            const [images, videos] = await Promise.all([
                searchProductImages(query),
                searchYouTubeVideos(query)
            ]);

            renderMedia(images, imgGrid, 'img');
            renderMedia(videos, vidGrid, 'vid');
            lucide.createIcons();
        }

        function renderMedia(items, container, type) {
            container.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "media-card bg-black rounded-lg aspect-video relative";
                div.onclick = () => {
                    container.querySelectorAll('.media-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    
                    if(type === 'img') {
                        document.getElementById('pImg').value = item.link;
                        document.getElementById('previewImg').src = item.link;
                    } else {
                        document.getElementById('pVideo').value = item.embed;
                        updateVideoPreview(item.embed);
                    }
                };
                div.innerHTML = `<img src="${type === 'img' ? item.link : item.thumbnail}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition">`;
                if(type === 'vid') div.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white drop-shadow-md" size="32"></i></div>';
                container.appendChild(div);
            });
        }

        // --- 2. Tech Specs AI ---
        window.fillTechData = async () => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return alert("住专 砖 爪专");
            
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> 注...';
            lucide.createIcons();

            const data = await extractTechnicalSpecs(name);
            document.getElementById('tCov').value = data.coverage || '';
            document.getElementById('tDry').value = data.drying || '';
            document.getElementById('tThick').value = data.thickness || '';
            
            btn.innerHTML = originalText;
            updatePreview();
        }

        // --- 3. Smart Google Search ---
        window.smartSearch = (type) => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return alert(" 砖 爪专 拽");

            let q = "";
            if(type === 'coverage') q = `${name} consumption coverage kg m2 technical data sheet`;
            if(type === 'drying') q = `${name} waiting time drying curing time technical data sheet`;
            if(type === 'thickness') q = `${name} layer thickness application min max mm technical data sheet`;
            if(type === 'pdf') q = `${name} Sika Technical Data Sheet pdf download`;

            window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
        }

        // --- Preview Logic ---
        function updateVideoPreview(url) {
            const container = document.getElementById('previewVideoContainer');
            const badge = document.getElementById('videoBadge');
            const iframe = document.getElementById('previewIframe');
            
            if(url) {
                container.classList.remove('hidden');
                badge.classList.remove('hidden');
                iframe.src = url;
            } else {
                container.classList.add('hidden');
                badge.classList.add('hidden');
                iframe.src = "";
            }
        }

        ['pName', 'pBrand', 'pDesc', 'tCov', 'tDry', 'tThick'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        function updatePreview() {
            document.getElementById('prevName').innerText = document.getElementById('pName').value || '砖 爪专';
            document.getElementById('prevBrand').innerText = document.getElementById('pBrand').value || 'BRAND';
            document.getElementById('prevDesc').innerText = document.getElementById('pDesc').value || '转专...';
            
            document.getElementById('prevCov').innerText = document.getElementById('tCov').value || '-';
            document.getElementById('prevDry').innerText = document.getElementById('tDry').value || '-';
            document.getElementById('prevThick').innerText = document.getElementById('tThick').value || '-';
        }

        // --- Firebase Logic ---
        async function loadInventory() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = '<div class="text-center py-4"><i data-lucide="loader-2" class="animate-spin text-gray-500"></i></div>';
            lucide.createIcons();

            try {
                const snap = await getDocs(collection(db, "products"));
                list.innerHTML = "";
                allProducts = [];
                snap.forEach(docSnap => {
                    const p = {id: docSnap.id, ...docSnap.data()};
                    allProducts.push(p);
                    list.innerHTML += `
                        <div onclick="loadProduct('${p.id}')" class="p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer flex gap-3 items-center group transition">
                            <img src="${p.image || 'https://placehold.co/50'}" class="w-10 h-10 rounded bg-white object-contain border border-gray-700">
                            <div class="overflow-hidden">
                                <div class="text-xs font-bold text-gray-300 group-hover:text-white truncate">${p.name}</div>
                                <div class="text-[10px] text-gray-500">${p.brand || ''}</div>
                            </div>
                            ${p.videoUrl ? '<i data-lucide="video" size="12" class="text-red-500 ml-auto"></i>' : ''}
                        </div>`;
                });
                lucide.createIcons();
            } catch(e) { console.error("Firebase Error", e); }
        }

        window.loadProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            
            document.getElementById('editId').value = id;
            document.getElementById('searchQuery').value = p.name;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.marketingDesc;
            document.getElementById('pImg').value = p.image;
            document.getElementById('pVideo').value = p.videoUrl || '';
            document.getElementById('tCov').value = p.tech?.coverage || '';
            document.getElementById('tDry').value = p.tech?.drying || '';
            document.getElementById('tThick').value = p.tech?.thickness || '';

            document.getElementById('previewImg').src = p.image || 'https://placehold.co/400';
            updateVideoPreview(p.videoUrl);
            updatePreview();

            // Clear media grids
            document.getElementById('imageGrid').innerHTML = '<div class="col-span-5 text-center text-gray-600 text-xs py-4">驻砖 砖 砖 转</div>';
            document.getElementById('videoGrid').innerHTML = '<div class="col-span-4 text-center text-gray-600 text-xs py-4">驻砖 砖 砖 </div>';
        }

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                category: document.getElementById('pCat').value,
                marketingDesc: document.getElementById('pDesc').value,
                image: document.getElementById('pImg').value,
                videoUrl: document.getElementById('pVideo').value,
                tech: {
                    coverage: document.getElementById('tCov').value,
                    drying: document.getElementById('tDry').value,
                    thickness: document.getElementById('tThick').value
                },
                updatedAt: Date.now()
            };

            if(!data.name) return alert("  砖 爪专");

            try {
                if(id) await updateDoc(doc(db, "products", id), data);
                else {
                    data.createdAt = Date.now();
                    await addDoc(collection(db, "products"), data);
                }
                loadInventory();
                window.clearForm();
            } catch(e) { alert("砖: " + e.message); }
        }

        window.clearForm = () => {
            document.getElementById('editId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('previewImg').src = "https://placehold.co/400?text=New";
            updateVideoPreview("");
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
