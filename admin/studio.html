<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Studio Master ğŸ› ï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #E3000F; }
        .media-card { cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative; }
        .media-card:hover { transform: scale(1.05); z-index: 10; border-color: #3b82f6; }
        .media-card.selected { border-color: #E3000F; box-shadow: 0 0 10px rgba(227, 0, 15, 0.5); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="flex">

    <div class="w-64 bg-gray-900 border-l border-gray-800 flex flex-col">
        <div class="p-4 border-b border-gray-800">
            <h1 class="text-2xl font-black text-[#E3000F] tracking-tighter">SIKA STUDIO</h1>
        </div>
        <div class="p-2">
            <button onclick="clearForm()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded font-bold">+ ×—×“×©</button>
        </div>
        <div id="inventoryList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>

    <div class="flex-1 p-6 overflow-y-auto">
        <div class="max-w-6xl mx-auto flex gap-6">
            
            <div class="w-2/3 space-y-5">
                
                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                    <div class="flex gap-2 mb-4">
                        <input id="searchQuery" class="input-dark font-bold text-lg" placeholder="×©× ××•×¦×¨ (×œ××©×œ: Sika 107)">
                        <button onclick="runAllSearches()" class="bg-[#E3000F] hover:bg-red-600 text-white px-6 rounded-lg font-bold flex items-center gap-2">
                            <i data-lucide="search"></i> ×—×¤×© ×”×›×œ
                        </button>
                    </div>

                    <div class="mb-4">
                        <h3 class="text-[10px] text-gray-400 font-bold uppercase mb-2">×ª××•× ×•×ª</h3>
                        <div id="imageGrid" class="grid grid-cols-5 gap-2 h-20"></div>
                    </div>

                    <div>
                        <h3 class="text-[10px] text-gray-400 font-bold uppercase mb-2">×•×™×“××•</h3>
                        <div id="videoGrid" class="grid grid-cols-4 gap-2 h-20"></div>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <input type="hidden" id="editId">
                    <div class="space-y-3">
                        <input id="pName" class="input-dark font-bold" placeholder="×©× ××•×¦×¨ ××œ×">
                        <div class="grid grid-cols-2 gap-3">
                            <input id="pBrand" class="input-dark" placeholder="××•×ª×’">
                            <select id="pCat" class="input-dark">
                                <option value="sealing">××™×˜×•×</option>
                                <option value="glues">×“×‘×§×™×</option>
                                <option value="flooring">×¨×™×¦×•×£</option>
                                <option value="concrete">×‘×˜×•×Ÿ</option>
                                <option value="paint">×¦×‘×¢</option>
                            </select>
                        </div>
                        <textarea id="pDesc" class="input-dark h-20 text-sm" placeholder="×ª×™××•×¨ ×©×™×•×•×§×™"></textarea>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input id="pImg" class="input-dark text-xs text-gray-500" readonly placeholder="Image URL">
                            <input id="pVideo" class="input-dark text-xs text-gray-500" readonly placeholder="Video URL">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-xs font-bold text-gray-400 flex items-center gap-2">
                            <i data-lucide="ruler"></i> ××¤×¨×˜ ×˜×›× ×™
                        </label>
                        <div class="flex gap-2">
                             <button onclick="fillTechData()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded flex items-center gap-1">
                                <i data-lucide="sparkles" size="12"></i> ×—×œ×¥ ××•×˜×•××˜×™×ª (AI)
                            </button>
                            <button onclick="openGoogleTDS()" class="bg-gray-700 hover:bg-gray-600 text-white text-xs px-3 py-1 rounded flex items-center gap-1">
                                <i data-lucide="external-link" size="12"></i> ×‘×“×•×§ ×‘×’×•×’×œ
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">×›×™×¡×•×™</span>
                            <input id="tCov" class="input-dark text-sm">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">×–××Ÿ ×™×™×‘×•×©</span>
                            <input id="tDry" class="input-dark text-sm">
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 block mb-1">×¢×•×‘×™ ×™×™×©×•×</span>
                            <input id="tThick" class="input-dark text-sm">
                        </div>
                    </div>
                </div>

                <button onclick="saveProduct()" class="w-full bg-[#E3000F] hover:bg-red-600 text-white py-3 rounded-lg font-bold text-lg shadow-lg">
                    ×©××•×¨ ××•×¦×¨
                </button>
            </div>

            <div class="w-1/3">
                <div class="sticky top-4 bg-white text-black rounded-2xl overflow-hidden shadow-2xl">
                    <div class="aspect-square bg-gray-100 flex items-center justify-center relative p-4">
                        <img id="previewImg" src="https://placehold.co/400?text=Sika" class="max-h-full max-w-full object-contain mix-blend-multiply">
                        <div id="videoBadge" class="absolute bottom-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded hidden">VIDEO</div>
                    </div>
                    <div class="p-5 space-y-2">
                        <div id="prevBrand" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">BRAND</div>
                        <h2 id="prevName" class="text-2xl font-black leading-tight">×©× ××•×¦×¨</h2>
                        <div class="h-1 w-8 bg-[#E3000F]"></div>
                        <p id="prevDesc" class="text-xs text-gray-600 line-clamp-4">×ª×™××•×¨...</p>
                        
                        <div id="previewVideoContainer" class="hidden mt-2 pt-2 border-t">
                            <iframe id="previewIframe" class="w-full aspect-video rounded bg-black" frameborder="0"></iframe>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mt-4 pt-4 border-t border-gray-100">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-400">×›×™×¡×•×™</div>
                                <div id="prevCov" class="font-bold text-xs">-</div>
                            </div>
                            <div class="text-center border-r border-gray-100">
                                <div class="text-[10px] text-gray-400">×™×™×‘×•×©</div>
                                <div id="prevDry" class="font-bold text-xs">-</div>
                            </div>
                            <div class="text-center border-r border-gray-100">
                                <div class="text-[10px] text-gray-400">×¢×•×‘×™</div>
                                <div id="prevThick" class="font-bold text-xs">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { searchProductImages, searchYouTubeVideos, askGeminiAdmin, extractTechnicalSpecs } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        // --- Main Search Orchestrator ---
        window.runAllSearches = async () => {
            const query = document.getElementById('searchQuery').value;
            if(!query) return;

            // 1. Basic Info
            if(!document.getElementById('pName').value) {
                document.getElementById('pName').value = query;
                askGeminiAdmin(query).then(data => {
                    if(data) {
                        document.getElementById('pDesc').value = data.marketingDesc;
                        document.getElementById('pBrand').value = data.brand;
                        updatePreview();
                    }
                });
            }

            // 2. Images & Video
            const imgGrid = document.getElementById('imageGrid');
            const vidGrid = document.getElementById('videoGrid');
            imgGrid.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            vidGrid.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            lucide.createIcons();

            const [images, videos] = await Promise.all([
                searchProductImages(query),
                searchYouTubeVideos(query)
            ]);

            renderMedia(images, imgGrid, 'img');
            renderMedia(videos, vidGrid, 'vid');
            lucide.createIcons();
        }

        function renderMedia(items, container, type) {
            container.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "media-card bg-black rounded overflow-hidden aspect-video relative";
                div.onclick = () => {
                    container.querySelectorAll('.media-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    if(type === 'img') {
                        document.getElementById('pImg').value = item.link;
                        document.getElementById('previewImg').src = item.link;
                    } else {
                        document.getElementById('pVideo').value = item.embed;
                        updateVideoPreview(item.embed);
                    }
                };
                div.innerHTML = `<img src="${type === 'img' ? item.link : item.thumbnail}" class="w-full h-full object-cover">`;
                if(type === 'vid') div.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white"></i></div>';
                container.appendChild(div);
            });
        }

        // --- AI Tech Specs Extraction ---
        window.fillTechData = async () => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return alert("×”×›× ×¡ ×©× ××•×¦×¨");
            
            const btn = event.currentTarget;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> ×—×•×©×‘...';
            lucide.createIcons();

            const data = await extractTechnicalSpecs(name);
            
            document.getElementById('tCov').value = data.coverage || '';
            document.getElementById('tDry').value = data.drying || '';
            document.getElementById('tThick').value = data.thickness || '';
            
            btn.innerHTML = '<i data-lucide="sparkles"></i> ×—×œ×¥ ××•×˜×•××˜×™×ª (AI)';
            lucide.createIcons();
            updatePreview();
        }

        // --- Google Verification Link ---
        window.openGoogleTDS = () => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return;
            const url = `https://www.google.com/search?q=${encodeURIComponent(name + " Sika Technical Data Sheet pdf")}`;
            window.open(url, '_blank');
        }

        // --- Preview Updates ---
        ['pName', 'pBrand', 'pDesc', 'tCov', 'tDry', 'tThick'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        function updatePreview() {
            document.getElementById('prevName').innerText = document.getElementById('pName').value || '×©× ×”××•×¦×¨';
            document.getElementById('prevBrand').innerText = document.getElementById('pBrand').value || 'BRAND';
            document.getElementById('prevDesc').innerText = document.getElementById('pDesc').value || '×ª×™××•×¨...';
            
            document.getElementById('prevCov').innerText = document.getElementById('tCov').value || '-';
            document.getElementById('prevDry').innerText = document.getElementById('tDry').value || '-';
            document.getElementById('prevThick').innerText = document.getElementById('tThick').value || '-';
        }

        function updateVideoPreview(url) {
            const container = document.getElementById('previewVideoContainer');
            const badge = document.getElementById('videoBadge');
            if(url) {
                container.classList.remove('hidden');
                badge.classList.remove('hidden');
                document.getElementById('previewIframe').src = url;
            } else {
                container.classList.add('hidden');
                badge.classList.add('hidden');
            }
        }

        // --- Firebase Integration ---
        async function loadInventory() {
            const list = document.getElementById('inventoryList');
            const snap = await getDocs(collection(db, "products"));
            allProducts = [];
            list.innerHTML = "";
            snap.forEach(docSnap => {
                const p = {id: docSnap.id, ...docSnap.data()};
                allProducts.push(p);
                list.innerHTML += `
                    <div onclick="loadProduct('${p.id}')" class="p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer flex items-center gap-2 group">
                        <img src="${p.image || 'https://placehold.co/50'}" class="w-8 h-8 rounded bg-white object-contain">
                        <div class="truncate text-xs font-bold text-gray-300 group-hover:text-white">${p.name}</div>
                    </div>`;
            });
        }

        window.loadProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editId').value = id;
            document.getElementById('searchQuery').value = p.name;
            
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.marketingDesc;
            document.getElementById('pImg').value = p.image;
            document.getElementById('pVideo').value = p.videoUrl || '';
            
            document.getElementById('tCov').value = p.tech?.coverage || '';
            document.getElementById('tDry').value = p.tech?.drying || '';
            document.getElementById('tThick').value = p.tech?.thickness || '';
            
            document.getElementById('previewImg').src = p.image || 'https://placehold.co/400';
            updatePreview();
            updateVideoPreview(p.videoUrl);
            
            // Clear grids
            document.getElementById('imageGrid').innerHTML = '';
            document.getElementById('videoGrid').innerHTML = '';
        }

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                category: document.getElementById('pCat').value,
                marketingDesc: document.getElementById('pDesc').value,
                image: document.getElementById('pImg').value,
                videoUrl: document.getElementById('pVideo').value,
                tech: {
                    coverage: document.getElementById('tCov').value,
                    drying: document.getElementById('tDry').value,
                    thickness: document.getElementById('tThick').value
                },
                updatedAt: Date.now()
            };
            
            if(id) await updateDoc(doc(db, "products", id), data);
            else {
                data.createdAt = Date.now();
                await addDoc(collection(db, "products"), data);
            }
            loadInventory();
            window.clearForm();
        }

        window.clearForm = () => {
            document.getElementById('editId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('previewImg').src = "https://placehold.co/400?text=New";
            updateVideoPreview("");
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
