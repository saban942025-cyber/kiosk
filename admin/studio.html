<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Studio Pro 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #E3000F; }
        .media-card { cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative; overflow: hidden; }
        .media-card:hover { transform: scale(1.05); z-index: 10; border-color: #3b82f6; }
        .media-card.selected { border-color: #E3000F; box-shadow: 0 0 15px rgba(227, 0, 15, 0.3); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        /* Tooltip style */
        .tooltip { position: relative; }
        .tooltip:hover::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; font-size: 10px; border-radius: 4px; white-space: nowrap; margin-bottom: 5px; }
    </style>
</head>
<body class="flex">

    <div class="w-72 bg-gray-900 border-l border-gray-800 flex flex-col z-20 shadow-xl">
        <div class="p-5 border-b border-gray-800 bg-gray-900">
            <h1 class="text-3xl font-black text-[#E3000F] tracking-tighter italic">SIKA STUDIO</h1>
            <p class="text-xs text-gray-500 mt-1">×’×¨×¡×ª ×¤×¨×• 2.0</p>
        </div>
        <div class="p-3 bg-gray-900 sticky top-0">
            <button onclick="clearForm()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2">
                <i data-lucide="plus-circle" size="18"></i> ××•×¦×¨ ×—×“×©
            </button>
        </div>
        <div id="inventoryList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>

    <div class="flex-1 p-6 overflow-y-auto bg-[#0f172a]">
        <div class="max-w-7xl mx-auto flex gap-8">
            
            <div class="w-2/3 space-y-6">
                
                <div class="bg-gray-800 p-3 rounded-xl border border-gray-700 flex justify-between items-center shadow-lg">
                    <div class="flex gap-2">
                        <button onclick="duplicateProduct()" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg tooltip" data-tip="×©×›×¤×œ ××•×¦×¨">
                            <i data-lucide="copy" size="18"></i>
                        </button>
                        <button onclick="generateQR()" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-lg tooltip" data-tip="×¦×•×¨ ×§×•×“ QR">
                            <i data-lucide="qr-code" size="18"></i>
                        </button>
                        <button onclick="shareWhatsApp()" class="bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg tooltip" data-tip="×©×œ×— ×‘×•×•××˜×¡××¤">
                            <i data-lucide="message-circle" size="18"></i>
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 font-mono" id="productIdDisplay">ID: New</div>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>
                    <div class="flex gap-3 mb-5">
                        <input id="searchQuery" class="input-dark font-bold text-lg" placeholder="×©× ××•×¦×¨ ×œ××™×ª×•×¨ ××•×˜×•××˜×™...">
                        <button onclick="runAllSearches()" class="bg-[#E3000F] hover:bg-red-600 text-white px-6 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                            <i data-lucide="sparkles"></i> ×—×¤×©
                        </button>
                    </div>
                    <div id="imageGrid" class="grid grid-cols-5 gap-3 h-24 content-start mb-4"></div>
                    <div id="videoGrid" class="grid grid-cols-4 gap-3 h-24 content-start"></div>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-md">
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <input id="pName" class="input-dark font-bold text-lg border-l-4 border-l-blue-500" placeholder="×©× ××œ×">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input id="pBrand" class="input-dark" placeholder="××•×ª×’">
                            <select id="pCat" class="input-dark">
                                <option value="sealing">××™×˜×•×</option>
                                <option value="glues">×“×‘×§×™×</option>
                                <option value="flooring">×¨×™×¦×•×£</option>
                                <option value="concrete">×‘×˜×•×Ÿ</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="text-xs text-gray-500">×ª×™××•×¨ ×©×™×•×•×§×™</label>
                                <div class="flex gap-1">
                                    <button onclick="rewrite('sales')" class="text-[10px] bg-purple-900 text-purple-200 px-2 py-0.5 rounded border border-purple-700 hover:bg-purple-800">ğŸ”¥ ×©×™×•×•×§×™</button>
                                    <button onclick="rewrite('pro')" class="text-[10px] bg-blue-900 text-blue-200 px-2 py-0.5 rounded border border-blue-700 hover:bg-blue-800">ğŸ‘” ××§×¦×•×¢×™</button>
                                    <button onclick="rewrite('short')" class="text-[10px] bg-gray-700 text-gray-300 px-2 py-0.5 rounded border border-gray-600 hover:bg-gray-600">âœ‚ï¸ ×§×¦×¨</button>
                                </div>
                            </div>
                            <textarea id="pDesc" class="input-dark h-24 text-sm leading-relaxed" placeholder="..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input id="pImg" class="input-dark text-[10px] text-gray-500" readonly placeholder="Image URL">
                            <input id="pVideo" class="input-dark text-[10px] text-gray-500" readonly placeholder="Video URL">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800 relative shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-sm font-bold text-gray-300 flex items-center gap-2"><i data-lucide="ruler" class="text-blue-500"></i> ××¤×¨×˜ ×˜×›× ×™</label>
                        <button onclick="fillTechData()" class="bg-blue-600/20 hover:bg-blue-600/40 text-blue-300 text-xs px-3 py-1.5 rounded-full flex items-center gap-1 transition border border-blue-500/30">
                            <i data-lucide="sparkles" size="12"></i> ××™×œ×•×™ ××•×˜×•××˜×™
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-5">
                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5"><span class="text-[11px] text-gray-500">×›×™×¡×•×™</span><button onclick="smartSearch('coverage')" class="text-gray-600 hover:text-white"><i data-lucide="search" size="10"></i></button></div>
                            <input id="tCov" class="input-dark text-sm" placeholder="1.5 ×§''×’ ×œ×''×¨">
                        </div>
                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5"><span class="text-[11px] text-gray-500">×™×™×‘×•×©</span><button onclick="smartSearch('drying')" class="text-gray-600 hover:text-white"><i data-lucide="search" size="10"></i></button></div>
                            <input id="tDry" class="input-dark text-sm" placeholder="24 ×©×¢×•×ª">
                        </div>
                        <div class="group">
                            <div class="flex justify-between items-center mb-1.5"><span class="text-[11px] text-gray-500">×¢×•×‘×™</span><button onclick="smartSearch('thickness')" class="text-gray-600 hover:text-white"><i data-lucide="search" size="10"></i></button></div>
                            <input id="tThick" class="input-dark text-sm" placeholder="2-5 ×''×">
                        </div>
                    </div>
                </div>

                <button onclick="saveProduct()" class="w-full bg-gradient-to-r from-[#E3000F] to-red-700 hover:from-red-600 hover:to-red-800 text-white py-4 rounded-xl font-bold text-xl shadow-lg flex justify-center gap-2 items-center">
                    <i data-lucide="save"></i> ×©××•×¨ ××•×¦×¨
                </button>
            </div>

            <div class="w-1/3 min-w-[320px]">
                <div class="sticky top-6 bg-white text-black rounded-[2.5rem] overflow-hidden shadow-2xl border-8 border-gray-900 flex flex-col h-[750px] relative">
                    <div class="h-[40%] bg-gray-100 flex items-center justify-center relative p-6 border-b border-gray-100">
                        <img id="previewImg" src="https://placehold.co/400?text=Sika" class="max-h-full max-w-full object-contain mix-blend-multiply">
                    </div>
                    <div class="p-6 flex-1 flex flex-col overflow-y-auto">
                        <div id="prevBrand" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">BRAND</div>
                        <h2 id="prevName" class="text-3xl font-black leading-none mb-3 text-gray-900">×©× ×”××•×¦×¨</h2>
                        <div class="flex gap-1 mb-4"><div class="h-1 w-8 bg-[#E3000F] rounded-full"></div></div>
                        <p id="prevDesc" class="text-sm text-gray-600 leading-relaxed mb-6">×ª×™××•×¨...</p>
                        <div class="bg-gray-50 rounded-xl p-4 grid grid-cols-3 gap-2 mb-4">
                            <div class="text-center"><div class="text-[9px] text-gray-400 font-bold">×›×™×¡×•×™</div><div id="prevCov" class="font-bold text-xs">-</div></div>
                            <div class="text-center border-r border-l border-gray-200"><div class="text-[9px] text-gray-400 font-bold">×™×™×‘×•×©</div><div id="prevDry" class="font-bold text-xs">-</div></div>
                            <div class="text-center"><div class="text-[9px] text-gray-400 font-bold">×¢×•×‘×™</div><div id="prevThick" class="font-bold text-xs">-</div></div>
                        </div>
                    </div>

                    <div id="qrOverlay" class="absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center hidden p-8 text-center animate-fade-in">
                        <h3 class="text-2xl font-black text-black mb-4">×¡×¨×•×§ ××•×ª×™</h3>
                        <img id="qrImage" src="" class="w-64 h-64 border-4 border-black rounded-xl mb-4">
                        <p class="text-gray-500 text-sm mb-6">×§×•×“ ×–×” ××¤× ×” ×œ×“×£ ×”××•×¦×¨ ×‘××¤×œ×™×§×¦×™×”</p>
                        <button onclick="document.getElementById('qrOverlay').classList.add('hidden')" class="bg-gray-200 text-black px-6 py-2 rounded-full font-bold">×¡×’×•×¨</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { searchProductImages, searchYouTubeVideos, askGeminiAdmin, extractTechnicalSpecs, improveText } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        // --- NEW FEATURES LOGIC --- //

        // 1. AI Rewriter
        window.rewrite = async (style) => {
            const currentDesc = document.getElementById('pDesc').value;
            if(!currentDesc) return alert("×›×ª×•×‘ ××©×”×• ×‘×ª×™××•×¨ ×§×•×“×!");
            
            const originalBtn = event.currentTarget.innerHTML;
            event.currentTarget.innerHTML = "â³...";
            
            const newText = await improveText(currentDesc, style);
            document.getElementById('pDesc').value = newText;
            updatePreview();
            
            event.currentTarget.innerHTML = originalBtn;
        }

        // 2. Duplicate Product
        window.duplicateProduct = () => {
            const id = document.getElementById('editId').value;
            if(!id) return alert("×‘×—×¨ ××•×¦×¨ ×œ×©×›×¤×•×œ ×§×•×“×");
            
            // ×× ×§×” ××ª ×”-ID ×›×“×™ ×©×™×™×•×•×¦×¨ ×—×“×©
            document.getElementById('editId').value = "";
            document.getElementById('productIdDisplay').innerText = "ID: New (Copy)";
            document.getElementById('pName').value += " (×”×¢×ª×§)";
            
            // ×× ×§×” ×’×¨×™×“×™× ×›×“×™ ×œ× ×œ×‘×œ×‘×œ
            document.getElementById('imageGrid').innerHTML = '<div class="col-span-5 text-center py-4 text-xs text-gray-500">×”×¢×ª×§ × ×•×¦×¨. ×‘×¦×¢ ×—×™×¤×•×© ×œ×©×™× ×•×™ ××“×™×”</div>';
            document.getElementById('videoGrid').innerHTML = '';
            
            alert("×”××•×¦×¨ ×©×•×›×¤×œ! ×¢×¨×•×š ××ª ×”×¤×¨×˜×™× ×•×œ×—×¥ ×¢×œ ×©××•×¨ ×œ×™×¦×™×¨×ª ××•×¦×¨ ×—×“×©.");
        }

        // 3. QR Generator
        window.generateQR = () => {
            const name = document.getElementById('pName').value;
            if(!name) return;
            
            // ×™×¦×™×¨×ª URL ××“×•××” (×‘×¤×•×¢×œ ×–×” ×™×”×™×” ×”×œ×™× ×§ ×œ××¤×œ×™×§×¦×™×” ×©×œ×š ×¢× ?id=...)
            const appLink = `https://saban942025-cyber.github.io/kiosk/mobile.html?product=${encodeURIComponent(name)}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(appLink)}`;
            
            document.getElementById('qrImage').src = qrUrl;
            document.getElementById('qrOverlay').classList.remove('hidden');
        }

        // 4. WhatsApp Share
        window.shareWhatsApp = () => {
            const name = document.getElementById('pName').value;
            const desc = document.getElementById('pDesc').value;
            const img = document.getElementById('pImg').value;
            
            if(!name) return;
            
            const text = `*×”×™×™, ×”× ×” ×¤×¨×˜×™× ×¢×œ ${name} ××¡×™×§×”-Ai:*\n\n${desc}\n\n×ª××•× ×”: ${img}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- CORE FUNCTIONS (Existing) --- //
        
        window.runAllSearches = async () => {
            const query = document.getElementById('searchQuery').value;
            if(!query) return;

            // AI Fill
            if(!document.getElementById('pName').value) {
                document.getElementById('pName').value = query;
                askGeminiAdmin(query).then(data => {
                    if(data) {
                        document.getElementById('pDesc').value = data.marketingDesc;
                        document.getElementById('pBrand').value = data.brand;
                        updatePreview();
                    }
                });
            }

            // Media
            const imgGrid = document.getElementById('imageGrid');
            const vidGrid = document.getElementById('videoGrid');
            imgGrid.innerHTML = '<i data-lucide="loader-2" class="animate-spin text-blue-500"></i>';
            vidGrid.innerHTML = '<i data-lucide="loader-2" class="animate-spin text-red-500"></i>';
            lucide.createIcons();

            const [images, videos] = await Promise.all([searchProductImages(query), searchYouTubeVideos(query)]);
            renderMedia(images, imgGrid, 'img');
            renderMedia(videos, vidGrid, 'vid');
            lucide.createIcons();
        }

        function renderMedia(items, container, type) {
            container.innerHTML = "";
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "media-card bg-black rounded-lg aspect-video relative";
                div.onclick = () => {
                    container.querySelectorAll('.media-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    if(type === 'img') {
                        document.getElementById('pImg').value = item.link;
                        document.getElementById('previewImg').src = item.link;
                    } else {
                        document.getElementById('pVideo').value = item.embed;
                    }
                };
                div.innerHTML = `<img src="${type === 'img' ? item.link : item.thumbnail}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition">`;
                if(type === 'vid') div.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white"></i></div>';
                container.appendChild(div);
            });
        }

        window.fillTechData = async () => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return alert("×—×¡×¨ ×©× ××•×¦×¨");
            
            const btn = event.currentTarget;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i>';
            lucide.createIcons();

            const data = await extractTechnicalSpecs(name);
            document.getElementById('tCov').value = data.coverage;
            document.getElementById('tDry').value = data.drying;
            document.getElementById('tThick').value = data.thickness;
            
            btn.innerHTML = '<i data-lucide="sparkles"></i> ××™×œ×•×™ ××•×˜×•××˜×™';
            lucide.createIcons();
            updatePreview();
        }

        window.smartSearch = (type) => {
            const name = document.getElementById('pName').value || document.getElementById('searchQuery').value;
            if(!name) return alert("×”×–×Ÿ ×©× ××•×¦×¨");
            let q = "";
            if(type === 'coverage') q = `${name} consumption coverage technical data sheet`;
            if(type === 'drying') q = `${name} drying time curing technical data sheet`;
            if(type === 'thickness') q = `${name} layer thickness technical data sheet`;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
        }

        ['pName', 'pBrand', 'pDesc', 'tCov', 'tDry', 'tThick'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        function updatePreview() {
            document.getElementById('prevName').innerText = document.getElementById('pName').value || '×©× ×”××•×¦×¨';
            document.getElementById('prevBrand').innerText = document.getElementById('pBrand').value || 'BRAND';
            document.getElementById('prevDesc').innerText = document.getElementById('pDesc').value || '×ª×™××•×¨...';
            document.getElementById('prevCov').innerText = document.getElementById('tCov').value || '-';
            document.getElementById('prevDry').innerText = document.getElementById('tDry').value || '-';
            document.getElementById('prevThick').innerText = document.getElementById('tThick').value || '-';
        }

        // Firebase Inventory
        async function loadInventory() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = '<div class="text-center py-4"><i data-lucide="loader-2" class="animate-spin text-gray-500"></i></div>';
            lucide.createIcons();

            try {
                const snap = await getDocs(collection(db, "products"));
                list.innerHTML = "";
                allProducts = [];
                snap.forEach(docSnap => {
                    const p = {id: docSnap.id, ...docSnap.data()};
                    allProducts.push(p);
                    list.innerHTML += `
                        <div onclick="loadProduct('${p.id}')" class="p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer flex gap-3 items-center group transition">
                            <img src="${p.image || 'https://placehold.co/50'}" class="w-10 h-10 rounded bg-white object-contain border border-gray-700">
                            <div class="overflow-hidden">
                                <div class="text-xs font-bold text-gray-300 group-hover:text-white truncate">${p.name}</div>
                                <div class="text-[10px] text-gray-500">${p.brand || ''}</div>
                            </div>
                        </div>`;
                });
            } catch(e) { console.error(e); }
        }

        window.loadProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editId').value = id;
            document.getElementById('productIdDisplay').innerText = `ID: ${id.slice(0,6)}...`;
            document.getElementById('searchQuery').value = p.name;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.marketingDesc;
            document.getElementById('pImg').value = p.image;
            document.getElementById('pVideo').value = p.videoUrl || '';
            document.getElementById('tCov').value = p.tech?.coverage || '';
            document.getElementById('tDry').value = p.tech?.drying || '';
            document.getElementById('tThick').value = p.tech?.thickness || '';

            document.getElementById('previewImg').src = p.image || 'https://placehold.co/400';
            updatePreview();
            
            // Clear grids
            document.getElementById('imageGrid').innerHTML = '<div class="col-span-5 text-center text-gray-600 text-xs py-4">×—×¤×© ××—×“×© ×œ×©×™× ×•×™ ×ª××•× ×”</div>';
            document.getElementById('videoGrid').innerHTML = '';
        }

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                category: document.getElementById('pCat').value,
                marketingDesc: document.getElementById('pDesc').value,
                image: document.getElementById('pImg').value,
                videoUrl: document.getElementById('pVideo').value,
                tech: {
                    coverage: document.getElementById('tCov').value,
                    drying: document.getElementById('tDry').value,
                    thickness: document.getElementById('tThick').value
                },
                updatedAt: Date.now()
            };

            if(!data.name) return alert("×—×•×‘×” ×œ××œ× ×©×");

            try {
                if(id) await updateDoc(doc(db, "products", id), data);
                else {
                    data.createdAt = Date.now();
                    await addDoc(collection(db, "products"), data);
                }
                loadInventory();
                window.clearForm();
            } catch(e) { alert("×©×’×™××”: " + e.message); }
        }

        window.clearForm = () => {
            document.getElementById('editId').value = "";
            document.getElementById('productIdDisplay').innerText = "ID: New";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('previewImg').src = "https://placehold.co/400?text=New";
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
