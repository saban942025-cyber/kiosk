<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Studio Pro </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #E3000F; }
        
        /* 专住  */
        .media-card { 
            position: relative; border-radius: 8px; overflow: hidden; 
            border: 2px solid transparent; cursor: pointer; transition: 0.2s;
            background: #000; aspect-ratio: 16/9;
        }
        .media-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .media-card:hover { border-color: #3b82f6; transform: scale(1.03); z-index: 10; }
        .media-card.selected { border-color: #E3000F; opacity: 1; }
        .media-card .badge { position: absolute; top: 5px; right: 5px; background: #E3000F; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        
        /* 住专  转 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="flex">

    <div class="w-72 bg-gray-900 border-l border-gray-800 flex flex-col">
        <div class="p-4 border-b border-gray-800">
            <h1 class="text-2xl font-black text-[#E3000F] tracking-tighter">SIKA STUDIO</h1>
            <p class="text-xs text-gray-500"> 转 转拽</p>
        </div>
        <div class="p-2">
            <button onclick="clearForm()" class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded text-sm font-bold shadow-lg">+ 爪专 砖</button>
        </div>
        <div id="inventoryList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </div>

    <div class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-6xl mx-auto flex gap-8">
            
            <div class="w-2/3 space-y-6">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="sparkles" class="text-yellow-500"></i> 转专  
                        </label>
                        <button onclick="runMediaSearch()" class="bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white px-6 py-2 rounded-lg font-bold shadow-md flex items-center gap-2">
                            <i data-lucide="search"></i> 驻砖 
                        </button>
                    </div>
                    
                    <input id="searchQuery" class="input-dark font-bold text-lg mb-4" placeholder="砖 爪专 驻砖 (: Sika TopSeal 107)">

                    <div class="mb-4">
                        <h3 class="text-xs text-gray-400 mb-2 font-bold uppercase">转转 (专 转)</h3>
                        <div id="imageGrid" class="grid grid-cols-4 gap-3 min-h-[80px]">
                            <div class="text-gray-500 text-xs col-span-4 text-center py-4">转 驻砖...</div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xs text-gray-400 mb-2 font-bold uppercase">住专  (专 )</h3>
                        <div id="videoGrid" class="grid grid-cols-3 gap-3 min-h-[80px]">
                            <div class="text-gray-500 text-xs col-span-3 text-center py-4">转 驻砖...</div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">驻专 爪专</h2>
                        <input type="hidden" id="editId">
                    </div>

                    <div class="space-y-4">
                        <input id="pName" class="input-dark font-bold" placeholder="砖 爪专 ">
                        <div class="grid grid-cols-2 gap-4">
                            <input id="pBrand" class="input-dark" placeholder="转">
                            <select id="pCat" class="input-dark">
                                <option value="sealing"></option>
                                <option value="glues">拽</option>
                                <option value="flooring">专爪祝</option>
                                <option value="concrete"></option>
                                <option value="paint">爪注</option>
                            </select>
                        </div>
                        <textarea id="pDesc" class="input-dark h-24" placeholder="转专 砖拽"></textarea>
                        
                        <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                            <input id="pImg" class="bg-transparent border-b border-gray-700 w-full" readonly placeholder="URL 转">
                            <input id="pVideo" class="bg-transparent border-b border-gray-700 w-full" readonly placeholder="URL ">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <label class="text-xs font-bold text-gray-500 mb-2 block">驻专 </label>
                    <div class="grid grid-cols-3 gap-3">
                        <input id="tCov" placeholder="住" class="input-dark text-xs">
                        <input id="tDry" placeholder="砖" class="input-dark text-xs">
                        <input id="tThick" placeholder="注" class="input-dark text-xs">
                    </div>
                </div>

                <button onclick="saveProduct()" class="w-full bg-[#E3000F] hover:bg-red-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg flex justify-center gap-2 transform transition hover:scale-[1.01]">
                    <i data-lucide="save"></i> 砖专 爪专
                </button>
            </div>

            <div class="w-1/3">
                <div class="sticky top-10 bg-white text-black rounded-3xl overflow-hidden shadow-2xl flex flex-col">
                    <div class="aspect-square bg-gray-100 flex items-center justify-center p-6 relative">
                        <img id="previewImg" src="https://placehold.co/400?text=Sika" class="max-h-full max-w-full object-contain mix-blend-multiply">
                        <div id="videoBadge" class="absolute bottom-4 right-4 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded flex items-center gap-1 hidden">
                            <i data-lucide="youtube" size="14"></i> VIDEO
                        </div>
                    </div>
                    
                    <div class="p-6 flex-1 flex flex-col space-y-3">
                        <div id="prevBrand" class="text-xs font-bold text-gray-400 uppercase tracking-widest">BRAND</div>
                        <h2 id="prevName" class="text-3xl font-black leading-tight">砖 爪专</h2>
                        <div class="h-1 w-10 bg-[#E3000F]"></div>
                        <p id="prevDesc" class="text-sm text-gray-600 line-clamp-4 leading-relaxed">转专 爪专 驻注 ...</p>
                        
                        <div id="previewVideoContainer" class="hidden mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs font-bold text-gray-400 mb-2"> 爪专祝:</p>
                            <iframe id="previewIframe" class="w-full aspect-video rounded-lg bg-black" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { searchProductImages, searchYouTubeVideos, askGeminiAdmin } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        // --- 驻拽爪转 驻砖 砖转 ---
        window.runMediaSearch = async () => {
            const query = document.getElementById('searchQuery').value;
            if(!query) return alert("  砖 爪专 驻砖");
            
            // 注 砖转 拽住  专拽
            if(!document.getElementById('pName').value) {
                document.getElementById('pName').value = query;
                updatePreview();
                
                // 住 砖  拽住 -AI 专拽注
                askGeminiAdmin(query).then(data => {
                    if(data && !document.getElementById('pDesc').value) {
                        document.getElementById('pDesc').value = data.marketingDesc;
                        document.getElementById('pBrand').value = data.brand;
                        updatePreview();
                    }
                });
            }

            // 拽爪 注
            document.getElementById('imageGrid').innerHTML = '<div class="col-span-4 text-center"><i data-lucide="loader-2" class="animate-spin inline"></i> 驻砖 转转...</div>';
            document.getElementById('videoGrid').innerHTML = '<div class="col-span-3 text-center"><i data-lucide="loader-2" class="animate-spin inline"></i> 驻砖 ...</div>';
            lucide.createIcons();

            // 专爪转 驻砖 拽
            const [images, videos] = await Promise.all([
                searchProductImages(query),
                searchYouTubeVideos(query)
            ]);

            // 爪转 转转
            const imgGrid = document.getElementById('imageGrid');
            imgGrid.innerHTML = "";
            images.forEach(img => {
                const div = document.createElement('div');
                div.className = "media-card";
                div.onclick = () => {
                    document.querySelectorAll('#imageGrid .media-card').forEach(c => c.classList.remove('selected'));
                    div.classList.add('selected');
                    document.getElementById('pImg').value = img.link;
                    document.getElementById('previewImg').src = img.link;
                };
                div.innerHTML = `<img src="${img.link}">`;
                imgGrid.appendChild(div);
            });

            // 爪转 
            const vidGrid = document.getElementById('videoGrid');
            vidGrid.innerHTML = "";
            if(videos.length === 0) {
                vidGrid.innerHTML = '<div class="col-span-3 text-center text-xs text-red-400"> 爪 住专 ( 砖-YouTube API 驻注)</div>';
            } else {
                videos.forEach(vid => {
                    const div = document.createElement('div');
                    div.className = "media-card";
                    div.onclick = () => {
                        document.querySelectorAll('#videoGrid .media-card').forEach(c => c.classList.remove('selected'));
                        div.classList.add('selected');
                        document.getElementById('pVideo').value = vid.embed;
                        updateVideoPreview(vid.embed);
                    };
                    div.innerHTML = `
                        <img src="${vid.thumbnail}">
                        <div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play-circle" class="text-white opacity-80" size="32"></i></div>
                        <div class="badge">YouTube</div>
                        <div class="absolute bottom-0 bg-black/70 text-white text-[10px] w-full p-1 truncate">${vid.title}</div>
                    `;
                    vidGrid.appendChild(div);
                });
            }
            lucide.createIcons();
        }

        // --- 注 转爪 拽 ---
        ['pName', 'pBrand', 'pDesc'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        function updatePreview() {
            document.getElementById('prevName').innerText = document.getElementById('pName').value || '砖 爪专';
            document.getElementById('prevBrand').innerText = document.getElementById('pBrand').value || 'BRAND';
            document.getElementById('prevDesc').innerText = document.getElementById('pDesc').value || '转专...';
        }

        function updateVideoPreview(embedUrl) {
            const container = document.getElementById('previewVideoContainer');
            const iframe = document.getElementById('previewIframe');
            const badge = document.getElementById('videoBadge');
            
            if(embedUrl) {
                container.classList.remove('hidden');
                badge.classList.remove('hidden');
                iframe.src = embedUrl;
            } else {
                container.classList.add('hidden');
                badge.classList.add('hidden');
                iframe.src = "";
            }
        }

        // ---  转 (Firebase) ---
        async function loadInventory() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = '<div class="text-center p-4"><i data-lucide="loader-2" class="animate-spin"></i></div>';
            lucide.createIcons();
            
            const snap = await getDocs(collection(db, "products"));
            allProducts = [];
            list.innerHTML = "";
            
            snap.forEach(docSnap => {
                const p = {id: docSnap.id, ...docSnap.data()};
                allProducts.push(p);
                list.innerHTML += `
                    <div onclick="loadProduct('${p.id}')" class="p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer flex gap-3 items-center group">
                        <img src="${p.image || 'https://placehold.co/50'}" class="w-10 h-10 rounded bg-white object-contain">
                        <div class="flex-1 overflow-hidden">
                            <div class="text-xs font-bold truncate text-white group-hover:text-blue-400 transition">${p.name}</div>
                            <div class="text-[10px] text-gray-500">${p.brand || ''}</div>
                        </div>
                        ${p.videoUrl ? '<i data-lucide="video" size="12" class="text-red-500"></i>' : ''}
                    </div>`;
            });
            lucide.createIcons();
        }

        window.loadProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editId').value = id;
            document.getElementById('searchQuery').value = p.name;
            
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.marketingDesc;
            document.getElementById('pImg').value = p.image;
            document.getElementById('pVideo').value = p.videoUrl || '';
            
            document.getElementById('tCov').value = p.tech?.coverage || '';
            document.getElementById('tDry').value = p.tech?.drying || '';
            document.getElementById('tThick').value = p.tech?.thickness || '';
            
            document.getElementById('previewImg').src = p.image || 'https://placehold.co/400';
            updatePreview();
            updateVideoPreview(p.videoUrl);
            
            // 驻住 专 驻砖
            document.getElementById('imageGrid').innerHTML = '<div class="col-span-4 text-center text-xs text-gray-500 py-4">爪注 驻砖 砖 砖 转</div>';
            document.getElementById('videoGrid').innerHTML = '<div class="col-span-3 text-center text-xs text-gray-500 py-4">爪注 驻砖 砖 砖 </div>';
        }

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                category: document.getElementById('pCat').value,
                marketingDesc: document.getElementById('pDesc').value,
                image: document.getElementById('pImg').value,
                videoUrl: document.getElementById('pVideo').value, // 砖 砖!
                tech: {
                    coverage: document.getElementById('tCov').value,
                    drying: document.getElementById('tDry').value,
                    thickness: document.getElementById('tThick').value
                },
                updatedAt: Date.now()
            };

            if(!data.name) return alert("  砖 爪专");

            try {
                if(id) {
                    await updateDoc(doc(db, "products", id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(db, "products"), data);
                }
                loadInventory();
                window.clearForm();
            } catch(e) {
                alert("砖 砖专: " + e.message);
            }
        }

        window.clearForm = () => {
            document.getElementById('editId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('previewImg').src = "https://placehold.co/400?text=New";
            updateVideoPreview("");
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
