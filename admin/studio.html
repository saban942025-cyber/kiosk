<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Sika Studio - Visual Edition ğŸ“¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Heebo', sans-serif; background: #0f172a; color: white; height: 100vh; overflow: hidden; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .input-dark:focus { border-color: #E3000F; }
        
        /* ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™ ×”×ª××•× ×•×ª */
        .img-card { 
            position: relative; border-radius: 8px; overflow: hidden; 
            border: 2px solid transparent; cursor: pointer; transition: 0.2s;
            height: 100px; background: #000;
        }
        .img-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .img-card:hover img { opacity: 1; }
        .img-card:hover { border-color: #3b82f6; transform: scale(1.05); z-index: 10; }
        .img-card.selected { border-color: #E3000F; }
        .img-card.selected img { opacity: 1; }
        
        .check-badge { 
            position: absolute; top: 2px; right: 2px; background: #E3000F; 
            color: white; border-radius: 50%; padding: 2px; display: none; 
        }
        .img-card.selected .check-badge { display: block; }
    </style>
</head>
<body class="flex">

    <div class="w-72 bg-gray-900 border-l border-gray-800 flex flex-col">
        <div class="p-4 border-b border-gray-800">
            <h1 class="text-2xl font-black text-[#E3000F] tracking-tighter">SIKA STUDIO</h1>
            <p class="text-xs text-gray-500">× ×™×”×•×œ ××œ××™ ×•×™×–×•××œ×™</p>
        </div>
        <div class="p-2">
            <button onclick="clearForm()" class="w-full bg-gray-800 hover:bg-gray-700 py-2 rounded text-sm font-bold border border-gray-700">+ ××•×¦×¨ ×—×“×©</button>
        </div>
        <div id="inventoryList" class="flex-1 overflow-y-auto p-2 space-y-1">
            </div>
    </div>

    <div class="flex-1 p-8 overflow-y-auto">
        <div class="max-w-5xl mx-auto flex gap-8">
            
            <div class="w-2/3 space-y-5">
                
                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-xl">
                    <label class="text-sm font-bold text-blue-400 mb-2 flex items-center gap-2">
                        <i data-lucide="image"></i> ××™×ª×•×¨ ×ª××•× ×•×ª (Google)
                    </label>
                    <div class="flex gap-2 mb-4">
                        <input id="searchQuery" class="input-dark font-bold text-lg" placeholder="×”×§×œ×“ ×©× ××•×¦×¨ ×œ×—×™×¤×•×© (×œ××©×œ: ×¡×™×§×” ×¤×œ×§×¡ 11FC)...">
                        <button onclick="runImageSearch()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-lg font-bold whitespace-nowrap flex items-center gap-2">
                            <i data-lucide="search"></i> ×—×¤×©
                        </button>
                    </div>

                    <div id="imageGrid" class="grid grid-cols-3 gap-3 hidden">
                        </div>
                </div>

                <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">×¤×¨×˜×™ ×”××•×¦×¨</h2>
                        <input type="hidden" id="editId">
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-400">×©× ××•×¦×¨ (×œ×ª×¦×•×’×”)</label>
                            <input id="pName" class="input-dark">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">××•×ª×’</label>
                                <input id="pBrand" class="input-dark">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">×§×˜×’×•×¨×™×”</label>
                                <select id="pCat" class="input-dark">
                                    <option value="sealing">××™×˜×•×</option>
                                    <option value="glues">×“×‘×§×™×</option>
                                    <option value="flooring">×¨×™×¦×•×£</option>
                                    <option value="concrete">×‘×˜×•×Ÿ</option>
                                    <option value="paint">×¦×‘×¢</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-400">×ª×™××•×¨ ×©×™×•×•×§×™</label>
                            <textarea id="pDesc" class="input-dark h-20"></textarea>
                        </div>
                        
                        <div>
                            <label class="text-xs text-gray-400">URL ×ª××•× ×” (× ×‘×—×¨ ××•×˜×•××˜×™×ª)</label>
                            <input id="pImg" class="input-dark text-xs text-gray-500">
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <label class="text-xs font-bold text-gray-500 mb-2 block">××¤×¨×˜ ×˜×›× ×™</label>
                    <div class="grid grid-cols-3 gap-3">
                        <input id="tCov" placeholder="×›×™×¡×•×™" class="input-dark text-xs">
                        <input id="tDry" placeholder="×™×™×‘×•×©" class="input-dark text-xs">
                        <input id="tThick" placeholder="×¢×•×‘×™" class="input-dark text-xs">
                    </div>
                </div>

                <button onclick="saveProduct()" class="w-full bg-[#E3000F] hover:bg-red-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg flex justify-center gap-2">
                    <i data-lucide="save"></i> ×©××•×¨ ××•×¦×¨
                </button>
            </div>

            <div class="w-1/3">
                <div class="sticky top-10 bg-white text-black rounded-3xl overflow-hidden shadow-2xl h-[500px] flex flex-col">
                    <div class="h-1/2 bg-gray-100 flex items-center justify-center p-6 relative">
                        <img id="previewImg" src="https://placehold.co/400?text=Sika" class="max-h-full max-w-full object-contain mix-blend-multiply">
                        <span class="absolute top-4 left-4 bg-black text-white text-[10px] font-bold px-2 py-1 rounded">PREVIEW</span>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <div id="prevBrand" class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">BRAND</div>
                        <h2 id="prevName" class="text-2xl font-black leading-tight mb-2">×©× ×”××•×¦×¨</h2>
                        <p id="prevDesc" class="text-sm text-gray-500 line-clamp-4">×”×ª×™××•×¨ ×™×•×¤×™×¢ ×›××Ÿ ×‘×–××Ÿ ×××ª...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { searchProductImages } from '../js/gemini-service.js';

        lucide.createIcons();
        let allProducts = [];

        // 1. ×—×™×¤×•×© ×ª××•× ×•×ª
        window.runImageSearch = async () => {
            const query = document.getElementById('searchQuery').value;
            if(!query) return alert("×× × ×”×–×Ÿ ×©× ××•×¦×¨ ×œ×—×™×¤×•×©");
            
            // ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×©× ×”××•×¦×¨ ×× ×”×•× ×¨×™×§
            if(!document.getElementById('pName').value) {
                document.getElementById('pName').value = query;
                updatePreview();
            }

            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '<div class="col-span-3 text-center text-gray-400 text-sm py-4"><i data-lucide="loader-2" class="animate-spin inline"></i> ××—×¤×© ×‘×’×•×’×œ...</div>';
            grid.classList.remove('hidden');
            lucide.createIcons();

            const images = await searchProductImages(query);
            
            grid.innerHTML = "";
            if(images.length === 0) {
                grid.innerHTML = '<div class="col-span-3 text-center text-red-400 text-sm">×œ× × ××¦××• ×ª×•×¦××•×ª</div>';
                return;
            }

            images.forEach(img => {
                const div = document.createElement('div');
                div.className = "img-card";
                div.onclick = () => selectImage(img.link, div);
                div.innerHTML = `
                    <img src="${img.link}" onerror="this.src='https://placehold.co/100?text=Error'">
                    <div class="check-badge"><i data-lucide="check" size="12"></i></div>
                `;
                grid.appendChild(div);
            });
            lucide.createIcons();
        }

        function selectImage(url, el) {
            document.querySelectorAll('.img-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            
            document.getElementById('pImg').value = url;
            document.getElementById('previewImg').src = url;
        }

        // 2. ×¢×“×›×•×Ÿ Live Preview
        ['pName', 'pBrand', 'pDesc'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });

        function updatePreview() {
            document.getElementById('prevName').innerText = document.getElementById('pName').value || '×©× ×”××•×¦×¨';
            document.getElementById('prevBrand').innerText = document.getElementById('pBrand').value || 'BRAND';
            document.getElementById('prevDesc').innerText = document.getElementById('pDesc').value || '×ª×™××•×¨...';
        }

        // 3. × ×™×”×•×œ ××œ××™
        async function loadInventory() {
            const list = document.getElementById('inventoryList');
            const snap = await getDocs(collection(db, "products"));
            allProducts = [];
            list.innerHTML = "";
            
            snap.forEach(docSnap => {
                const p = {id: docSnap.id, ...docSnap.data()};
                allProducts.push(p);
                list.innerHTML += `
                    <div onclick="loadProduct('${p.id}')" class="p-3 border-b border-gray-800 hover:bg-gray-800 cursor-pointer flex gap-3 items-center">
                        <img src="${p.image}" class="w-8 h-8 rounded bg-white object-contain">
                        <div class="text-xs font-bold truncate">${p.name}</div>
                    </div>`;
            });
        }

        window.loadProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editId').value = id;
            document.getElementById('searchQuery').value = p.name;
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand;
            document.getElementById('pCat').value = p.category;
            document.getElementById('pDesc').value = p.marketingDesc;
            document.getElementById('pImg').value = p.image;
            document.getElementById('tCov').value = p.tech?.coverage || '';
            document.getElementById('tDry').value = p.tech?.drying || '';
            document.getElementById('tThick').value = p.tech?.thickness || '';
            
            document.getElementById('previewImg').src = p.image;
            updatePreview();
            
            // × ×™×§×•×™ ×ª×•×¦××•×ª ×—×™×¤×•×© ×™×©× ×•×ª
            document.getElementById('imageGrid').classList.add('hidden');
        }

        window.saveProduct = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('pName').value,
                brand: document.getElementById('pBrand').value,
                category: document.getElementById('pCat').value,
                marketingDesc: document.getElementById('pDesc').value,
                image: document.getElementById('pImg').value,
                tech: {
                    coverage: document.getElementById('tCov').value,
                    drying: document.getElementById('tDry').value,
                    thickness: document.getElementById('tThick').value
                },
                updatedAt: Date.now()
            };

            if(!data.name || !data.image) return alert("×—×¡×¨ ×©× ××• ×ª××•× ×”!");

            try {
                if(id) {
                    await updateDoc(doc(db, "products", id), data);
                } else {
                    data.createdAt = Date.now();
                    await addDoc(collection(db, "products"), data);
                }
                alert("× ×©××¨! âœ…");
                loadInventory();
                window.clearForm();
            } catch(e) {
                alert("×©×’×™××”: " + e.message);
            }
        }

        window.clearForm = () => {
            document.getElementById('editId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('previewImg').src = "https://placehold.co/400?text=New";
            document.getElementById('imageGrid').classList.add('hidden');
            updatePreview();
        }

        loadInventory();
    </script>
</body>
</html>
